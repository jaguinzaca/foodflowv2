{% extends 'comun/esquema.html' %}
{% block title %}Mesero - FoodFlow{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    /* --- ESTILOS MESERO POS (ACTUALIZADOS) --- */
    
    /* √Årea Principal (Men√∫) */
    .menu-section {
        background-color: #f3f4f6;
        padding-right: 15px;
        border-right: 1px solid #e5e7eb;
        height: calc(100vh - 70px);
        overflow-y: auto;
    }

    /* Buscador */
    .search-container {
        position: relative;
    }
    .search-input {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 50px;
        padding: 0.8rem 1rem 0.8rem 2.5rem;
        width: 100%;
        transition: 0.2s;
    }
    .search-input:focus {
        border-color: var(--brand-orange);
        outline: none;
        box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.1);
    }

    /* Categor√≠as */
    .cat-btn {
        background: white;
        border: 1px solid #e5e7eb;
        color: #6b7280;
        padding: 10px 20px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: 0.2s;
        white-space: nowrap;
        cursor: pointer;
    }
    .cat-btn:hover { background: #f9fafb; transform: translateY(-1px); }
    .cat-btn.active {
        background: var(--brand-dark);
        color: var(--brand-orange);
        border-color: var(--brand-dark);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* Tarjetas de Producto */
    .product-card {
        border: none;
        border-radius: 16px;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        background: white;
        overflow: hidden;
    }
    .product-card:active { transform: scale(0.96); }
    .product-card:hover {
        box-shadow: 0 10px 20px -3px rgba(0, 0, 0, 0.1);
        transform: translateY(-3px);
    }
    .price-tag {
        color: var(--brand-orange);
        font-weight: 800;
        font-size: 1.2rem;
    }
    .add-btn-mini {
        background: var(--brand-orange);
        color: white;
        border-radius: 50%;
        width: 36px; height: 36px;
        display: flex; align-items: center; justify-content: center;
        transition: 0.2s;
        box-shadow: 0 2px 5px rgba(249, 115, 22, 0.3);
    }

    /* --- SIDEBAR DERECHO (TICKET) --- */
    .ticket-sidebar {
        background: white;
        height: calc(100vh - 70px); 
        position: sticky;
        top: 70px;
        display: flex;
        flex-direction: column;
        z-index: 100;
        border-left: 1px solid #e5e7eb;
    }

    .ticket-header {
        background: var(--brand-dark);
        color: white;
        padding: 1.2rem 1.5rem;
        border-bottom: 4px solid var(--brand-orange);
    }

    .ticket-body {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: #fff;
    }

    /* --- ESTILO TARJETA GRANDE --- */
    .tarjeta-pedido {
        background: white;
        border: 1px solid #e2e8f0;
        border-left: 5px solid #f97316;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .nombre-producto {
        font-size: 1.15rem;
        font-weight: 800;
        color: #1f2937;
        line-height: 1.2;
    }

    .controles-cantidad {
        background: #f3f4f6;
        border-radius: 8px;
        padding: 4px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .btn-qty {
        width: 32px; height: 32px;
        border-radius: 6px;
        border: none;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
    }
    .btn-menos { background: #fee2e2; color: #ef4444; }
    .btn-mas { background: #dcfce7; color: #16a34a; }

    .ticket-footer {
        background: #fff;
        padding: 1.5rem;
        border-top: 1px solid #e5e7eb;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }

    /* Selector de Mesas */
    .mesa-selector { 
        min-height: 180px; 
        border-radius: 16px; 
        cursor: pointer; 
        transition: 0.2s; 
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .mesa-selector:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0,0,0,0.1) !important; }
    
    /* Estados Visuales Mesas */
    .mesa-libre { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }
    .mesa-esperando { background: #ffedd5; color: #9a3412; border: 2px solid #f97316; }
    .mesa-ocupada { background: #fee2e2; color: #991b1b; border: 2px solid #ef4444; }
    .mesa-lista { background: #dbeafe; color: #1e40af; border: 2px solid #3b82f6; }
    .mesa-reservada { background: #f3f4f6; color: #4b5563; border: 2px solid #9ca3af; border-style: dashed; opacity: 0.7; }

    /* Badge del Mesero */
    .waiter-badge {
        background: white;
        padding: 8px 16px;
        border-radius: 50px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        font-size: 0.9rem;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* Colores barra inferior mesa */
    .barra-libre { background-color: #10b981; }
    .barra-esperando { background-color: #f97316; }
    .barra-lista { background-color: #3b82f6; }
    .barra-ocupada { background-color: #ef4444; }
    .barra-reservada { background-color: #9ca3af; }
    .barra-default { background-color: #9ca3af; }

    /* --- ESTILOS DE PAGOS (ARREGLADOS) --- */
    .payment-options-container {
        display: flex;
        gap: 10px; /* Espacio entre botones */
        margin-bottom: 15px;
    }
    
    .payment-radio { 
        display: none; /* Ocultar el c√≠rculo del radio */ 
    } 
    
    .payment-label {
        flex: 1; /* Que todos ocupen el mismo ancho */
        border: 1px solid #d1d5db;
        border-radius: 10px;
        padding: 10px 5px;
        text-align: center;
        cursor: pointer;
        background: white;
        transition: all 0.2s;
        display: flex;
        flex-direction: column; /* Icono arriba, texto abajo */
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        color: #4b5563;
    }
    
    .payment-label i {
        font-size: 1.4rem;
        margin-bottom: 5px;
        color: var(--brand-orange);
    }
    
    /* Cuando se selecciona una opci√≥n */
    .payment-radio:checked + .payment-label {
        border-color: var(--brand-orange);
        background-color: #fff7ed; /* Naranja muy suave */
        color: #c2410c; /* Naranja oscuro */
        font-weight: 700;
        box-shadow: 0 2px 5px rgba(249, 115, 22, 0.2);
        transform: translateY(-2px);
    }

</style>

<div class="container-fluid p-0">
    <div class="row g-0">
        
       <div id="columna-menu" class="col-lg-7 menu-section p-4 h-100 overflow-auto transition-all"> 
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center gap-3">
                    <h3 class="fw-bold text-dark m-0" id="titulo-seccion">
                        <i class="bi bi-grid-fill text-warning me-2"></i>Selecciona una Mesa
                    </h3>
                    <button id="btn-abrir-ticket" class="btn btn-dark btn-sm rounded-pill px-3 d-none fade-in" onclick="toggleTicket()">
                        <i class="bi bi-receipt me-1"></i> Ver Orden
                    </button>
                </div>
                
                <div class="waiter-badge">
                    <div class="rounded-circle bg-warning text-dark d-flex justify-content-center align-items-center fw-bold" style="width: 28px; height: 28px;">
                        {{ user.username|first|upper }}
                    </div>
                    <span>Atiende: <strong>{{ user.username|title }}</strong></span>
                </div>
            </div>

            <div id="vista-mesas" class="fade-in">
                <div class="row g-3">
                    {% for mesa in mesas %}
                    <div class="col-6 col-md-6 col-xl-4">
                        <div class="card mesa-selector h-100 shadow-sm position-relative overflow-hidden border-0"
                             style="min-height: 180px; background: {% if mesa.estado == 'lista' %}#eff6ff{% elif mesa.estado == 'ocupada' %}#fef2f2{% else %}white{% endif %};"
                             onclick="abrirMesa('{{ mesa.id }}', '{{ mesa.numero }}')">
                            
                            <div class="card-body d-flex flex-column justify-content-center align-items-center position-relative z-1 w-100">
                                
                                <i class="bi 
                                    {% if mesa.estado == 'libre' %}bi-check-circle text-success
                                    {% elif mesa.estado == 'esperando' %}bi-clock-history text-warning
                                    {% elif mesa.estado == 'lista' %}bi-bell-fill text-primary
                                    {% elif mesa.estado == 'reservada' %}bi-calendar-check text-secondary
                                    {% else %}bi-people-fill text-danger{% endif %}" 
                                    style="font-size: 5rem; opacity: 0.15; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                </i>
                                
                                <h2 class="fw-bold m-0 mb-3 display-6 text-dark" style="z-index: 2;">Mesa {{ mesa.numero }}</h2>
                                
                                <div style="z-index: 3; width: 100%; text-align: center;">
                                    {% if mesa.estado == 'lista' %}
                                        <a href="{% url 'procesar_pago' mesa.id %}" 
                                           class="btn btn-primary fw-bold shadow px-4 py-2 rounded-pill"
                                           style="border: 2px solid white; white-space: nowrap;"
                                           onclick="event.stopPropagation(); return confirm('¬øConfirmar pago y liberar mesa?');">
                                           <i class="bi bi-check2-all me-2"></i>LIBERAR MESA
                                        </a>
                                    {% else %}
                                        <span class="badge rounded-pill text-uppercase border shadow-sm px-3 py-2
                                            {% if mesa.estado == 'libre' %}bg-success text-white border-success
                                            {% elif mesa.estado == 'esperando' %}bg-warning text-dark border-warning
                                            {% elif mesa.estado == 'reservada' %}bg-secondary text-white border-secondary
                                            {% else %}bg-danger text-white border-danger{% endif %}">
                                            
                                            {% if mesa.estado == 'libre' %} <i class="bi bi-check2"></i> DISPONIBLE
                                            {% elif mesa.estado == 'esperando' %} <i class="bi bi-hourglass-split"></i> COCINANDO...
                                            {% elif mesa.estado == 'reservada' %} <i class="bi bi-lock-fill"></i> RESERVADA
                                            {% else %} <i class="bi bi-utensils"></i> OCUPADA {% endif %}
                                        </span>
                                    {% endif %}
                                </div>

                            </div>
                            
                            <div class="position-absolute bottom-0 start-0 w-100 barra-{{ mesa.estado|default:'default' }}" style="height: 6px;"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div id="vista-menu" class="d-none">
                <div class="d-flex align-items-center gap-3 mb-4 sticky-top bg-light py-2" style="z-index: 10;">
                    <button class="btn btn-white border shadow-sm rounded-circle p-2 text-secondary" onclick="volverAMesas()">
                        <i class="bi bi-arrow-left fs-4"></i>
                    </button>
                    
                    <div class="search-container flex-grow-1">
                        <i class="bi bi-search position-absolute text-muted" style="left: 1rem; top: 50%; transform: translateY(-50%);"></i>
                        <input type="text" id="buscador" class="search-input" placeholder="Buscar un producto..." onkeyup="filtrarProductos()">
                    </div>
                </div>

                <div class="d-flex gap-2 overflow-auto pb-3 mb-3">
                    <button class="cat-btn active" onclick="filtrarCat('todas', this)">Todas</button>
                    {% for cat in categorias %}
                    <button class="cat-btn" onclick="filtrarCat('cat-{{ cat.id }}', this)">
                        {% if cat.nombre == 'Bebidas' %}ü•§{% elif cat.nombre == 'Hamburguesas' %}üçî{% else %}üçΩÔ∏è{% endif %} 
                        {{ cat.nombre }}
                    </button>
                    {% endfor %}
                </div>

                <div class="row g-3">
                    {% for cat in categorias %}
                        {% for prod in cat.productos.all %}
                        <div class="col-6 col-md-4 col-xl-4 producto-item cat-{{ cat.id }}" data-name="{{ prod.nombre|lower }}">
                            <div class="card product-card h-100 shadow-sm p-3 position-relative" 
                                 onclick="agregarAlCarrito('{{ prod.id }}', '{{ prod.nombre }}', '{{ prod.precio }}')">
                                
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                   <div class="overflow-hidden rounded-3 mb-2 d-flex align-items-center justify-content-center bg-light" style="height: 120px; width: 100%;">
                                        {% if prod.imagen %}
                                            <img src="{{ prod.imagen.url }}" alt="{{ prod.nombre }}" style="width: 100%; height: 100%; object-fit: cover;">
                                        {% else %}
                                            <i class="bi bi-camera-fill text-secondary fs-1 opacity-25"></i>
                                        {% endif %}
                                    </div>
                                    <div class="add-btn-mini"><i class="bi bi-plus-lg"></i></div>
                                </div>
                                
                                <h6 class="fw-bold text-dark mb-1">{{ prod.nombre }}</h6>
                                {% if prod.descripcion %}
                                <p class="text-muted small m-0 mb-2" style="font-size: 0.8rem; line-height: 1.2;">
                                    {{ prod.descripcion|truncatechars:45 }}
                                </p>
                                {% else %}
                                    <div class="mb-2" style="height: 18px;"></div>
                                {% endif %}

                                <div class="price-tag">${{ prod.precio }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div id="columna-ticket" class="col-lg-5 p-0 transition-all"> 
            <div class="ticket-sidebar shadow-lg">
                <div class="ticket-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-sm btn-outline-light border-0 me-2" onclick="toggleTicket()">
                            <i class="bi bi-x-lg"></i>
                        </button>
                        <div>
                            <h4 class="fw-bold m-0"><i class="bi bi-receipt me-2"></i>Orden Actual</h4>
                            <div class="badge bg-warning text-dark mt-1" id="mesa-badge-ticket">Sin Mesa</div>
                        </div>
                        <div class="text-end">
                            <div class="fs-5 fw-bold font-monospace" id="orden-id">#----</div>
                            <div class="small opacity-75"><i class="bi bi-clock"></i> <span id="reloj">00:00</span></div>
                        </div>
                    </div>
                </div>

                <div class="ticket-body" id="lista-carrito">
                    <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted opacity-50">
                        <i class="bi bi-basket2 display-1 mb-3"></i>
                        <h5>Orden Vac√≠a</h5>
                        <p>Selecciona productos del men√∫</p>
                    </div>
                </div>

                <div class="ticket-footer">
                    
                    <div class="mb-3">
                        <label class="small text-muted fw-bold mb-1">CLIENTE FRECUENTE:</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-person-vcard"></i></span>
                            <input type="text" id="cliente-cedula" class="form-control bg-light border-start-0" 
                                   placeholder="C√©dula o RUC (Opcional)" maxlength="13">
                        </div>
                    </div>

                    <div class="input-group mb-3">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-chat-left-text"></i></span>
                        <input type="text" id="nota-general" class="form-control bg-light border-start-0" placeholder="Nota para cocina...">
                    </div>

                    <div class="form-check form-switch mb-3 p-2 bg-light rounded d-flex justify-content-between align-items-center px-3">
                        <label class="form-check-label fw-bold text-danger mb-0" for="checkUrgente">
                            <i class="bi bi-fire me-1"></i> Prioridad Urgente
                        </label>
                        <input class="form-check-input" type="checkbox" role="switch" id="checkUrgente" style="width: 3rem; height: 1.5rem;">
                    </div>

                    <label class="small text-muted fw-bold mb-2 d-block">M√âTODO DE PAGO:</label>
                    <div class="payment-options-container d-flex gap-2 mb-3">
                        
                        <div class="flex-fill">
                            <input type="radio" class="btn-check" name="metodo_pago" id="pago_efectivo" value="efectivo" checked>
                            <label class="btn btn-outline-warning w-100" for="pago_efectivo">
                                <i class="bi bi-cash-coin"></i> Efectivo
                            </label>
                        </div>

                        <div class="flex-fill">
                            <input type="radio" class="btn-check" name="metodo_pago" id="pago_tarjeta" value="tarjeta">
                            <label class="btn btn-outline-warning w-100" for="pago_tarjeta">
                                <i class="bi bi-credit-card-2-front"></i> Tarjeta
                            </label>
                        </div>

                        <div class="flex-fill">
                            <input type="radio" class="btn-check" name="metodo_pago" id="pago_transferencia" value="transferencia">
                            <label class="btn btn-outline-warning w-100" for="pago_transferencia">
                                <i class="bi bi-qr-code-scan"></i> Transferencia
                            </label>
                        </div>

                    </div>
                    
                    <hr class="text-muted opacity-25">
                    
                    <div class="d-flex justify-content-between mb-1 text-secondary">
                        <span>Subtotal:</span>
                        <span id="lbl-subtotal" class="fw-bold text-dark">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 text-secondary">
                        <span>IVA (15%):</span>
                        <span id="lbl-iva" class="fw-bold text-dark">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center border-top pt-3 mb-3">
                        <span class="h4 fw-bold text-dark m-0">Total</span>
                        <span class="h3 fw-bold text-primary m-0" id="lbl-total">$0.00</span>
                    </div>

                    <button class="btn btn-lg w-100 fw-bold text-white shadow-sm" style="background: var(--brand-orange);" onclick="enviarPedidoBackend()">
                        <i class="bi bi-send-check-fill me-2"></i> CONFIRMAR PEDIDO
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // --- VARIABLES GLOBALES ---
    let mesaActualId = null;
    let carrito = [];
    const IVA_RATE = 0.15;
    const NEXT_ORDER_ID = "{{ siguiente_id }}";

    // --- RELOJ ---
    setInterval(() => {
        const now = new Date();
        const reloj = document.getElementById('reloj');
        if(reloj) reloj.innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }, 1000);


    // --- FUNCI√ìN 1: ABRIR MESA ---
    function abrirMesa(id, numero) {
        mesaActualId = id;
        
        const ordenIdElem = document.getElementById('orden-id');
        if(ordenIdElem) {
            ordenIdElem.innerText = "#" + NEXT_ORDER_ID; 
            ordenIdElem.classList.remove('text-success'); 
        }
        
        const badgeTicket = document.getElementById('mesa-badge-ticket');
        if(badgeTicket) badgeTicket.innerText = "Mesa " + numero;
        
        const titulo = document.getElementById('titulo-seccion');
        if(titulo) titulo.innerHTML = '<i class="bi bi-bag-plus-fill text-warning me-2"></i>Tomando Pedido: Mesa ' + numero;
        
        const vistaMesas = document.getElementById('vista-mesas');
        const vistaMenu = document.getElementById('vista-menu');
        
        if(vistaMesas && vistaMenu) {
            vistaMesas.classList.add('d-none');
            vistaMenu.classList.remove('d-none');
        }
        
        carrito = [];
        renderizarCarrito();
    }


    // --- FUNCI√ìN 2: VOLVER AL MAPA ---
    function volverAMesas() {
        const vistaMesas = document.getElementById('vista-mesas');
        const vistaMenu = document.getElementById('vista-menu');
        
        if(vistaMesas && vistaMenu) {
            vistaMenu.classList.add('d-none');
            vistaMesas.classList.remove('d-none');
        }
        
        const badgeTicket = document.getElementById('mesa-badge-ticket');
        if(badgeTicket) badgeTicket.innerText = "Sin Mesa";
        
        const titulo = document.getElementById('titulo-seccion');
        if(titulo) titulo.innerHTML = '<i class="bi bi-grid-fill text-warning me-2"></i>Selecciona una Mesa';
        
        const listaCarrito = document.getElementById('lista-carrito');
        if(listaCarrito) {
            listaCarrito.innerHTML = `
                <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted opacity-50">
                    <i class="bi bi-basket2 display-1 mb-3"></i>
                    <h5>Orden Vac√≠a</h5>
                </div>`;
        }
        resetTotales();
        setTimeout(() => location.reload(), 500); 
    }


    // --- FUNCI√ìN 3: FILTROS DE MEN√ö ---
    function filtrarCat(clase, btn) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.producto-item').forEach(el => {
            el.style.display = (clase === 'todas' || el.classList.contains(clase)) ? 'block' : 'none';
        });
    }

    function filtrarProductos() {
        const buscador = document.getElementById('buscador');
        if(!buscador) return;
        const texto = buscador.value.toLowerCase();
        
        document.querySelectorAll('.producto-item').forEach(el => {
            el.style.display = el.getAttribute('data-name').includes(texto) ? 'block' : 'none';
        });
    }


    // --- FUNCI√ìN 4: GESTI√ìN DEL CARRITO ---
    function agregarAlCarrito(id, nombre, precio) {
        let p = parseFloat(precio);
        let item = carrito.find(i => i.id === id);
        
        if(item) {
            item.cantidad++;
        } else {
            carrito.push({id, nombre, precio: p, cantidad: 1, nota: ''});
        }
        renderizarCarrito();
    }

    function quitarItem(index) {
        carrito.splice(index, 1);
        renderizarCarrito();
    }

    // --- FUNCI√ìN NUEVA: Para que funcione el bot√≥n de restar (-) ---
    function restarCantidad(index) {
        if (carrito[index].cantidad > 1) {
            carrito[index].cantidad--;
            renderizarCarrito();
        } else {
            if(confirm("¬øEliminar este producto?")) {
                quitarItem(index);
            }
        }
    }

    // --- FUNCI√ìN QUE DIBUJA EL CARRITO (VERSI√ìN TARJETA GRANDE) ---
    function renderizarCarrito() {
        const div = document.getElementById('lista-carrito');
        if(!div) return;
        
        if (carrito.length === 0) {
            div.innerHTML = `
                <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted opacity-50">
                    <i class="bi bi-basket2 display-1 mb-3"></i>
                    <h5>Orden Vac√≠a</h5>
                    <p class="small">Selecciona productos del men√∫</p>
                </div>`;
            resetTotales();
            return;
        }

        div.innerHTML = '';
        let subtotal = 0;

        carrito.forEach((item, index) => {
            let totalItem = item.precio * item.cantidad;
            subtotal += totalItem;

            div.innerHTML += `
                <div class="tarjeta-pedido animated-item"> 
                    
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="nombre-producto" style="width: 70%;">
                            ${item.nombre}
                        </div>
                        <div class="fw-bold text-dark fs-5">
                            $${totalItem.toFixed(2)}
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">Unitario: $${item.precio.toFixed(2)}</span>
                        
                        <div class="controles-cantidad border">
                            <button class="btn-qty btn-menos" onclick="restarCantidad(${index})">
                                <i class="bi bi-dash"></i>
                            </button>
                            
                            <span class="fw-bold text-dark fs-5 mx-2">${item.cantidad}</span>
                            
                            <button class="btn-qty btn-mas" onclick="agregarAlCarrito('${item.id}', '${item.nombre}', '${item.precio}')">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-pencil-square"></i></span>
                        <input type="text" class="form-control bg-light border-start-0" 
                               style="font-size: 0.9rem;"
                               placeholder="Nota (ej. Sin cebolla)..." value="${item.nota}" 
                               onchange="carrito[${index}].nota = this.value">
                        
                        <button class="btn btn-outline-danger ms-2 rounded" onclick="quitarItem(${index})" title="Eliminar">
                            <i class="bi bi-trash3-fill"></i>
                        </button>
                    </div>

                </div>
            `;
        });
        calcularTotales(subtotal);
    }

    function calcularTotales(subtotal) {
        let iva = subtotal * IVA_RATE;
        let total = subtotal + iva;
        
        const lblSub = document.getElementById('lbl-subtotal');
        const lblIva = document.getElementById('lbl-iva');
        const lblTot = document.getElementById('lbl-total');
        
        if(lblSub) lblSub.innerText = `$${subtotal.toFixed(2)}`;
        if(lblIva) lblIva.innerText = `$${iva.toFixed(2)}`;
        if(lblTot) lblTot.innerText = `$${total.toFixed(2)}`;
    }

    function resetTotales() {
        calcularTotales(0);
    }


    // --- FUNCI√ìN 5: ENVIAR PEDIDO (BACKEND) ---
   // --- FUNCI√ìN 5: ENVIAR PEDIDO (CON C√âDULA) ---
    function enviarPedidoBackend() {
        if(carrito.length === 0) return alert("‚ö†Ô∏è El pedido est√° vac√≠o.");
        
        const inputPago = document.querySelector('input[name="metodo_pago"]:checked');
        if (!inputPago) return alert("‚ö†Ô∏è Selecciona un m√©todo de pago.");
        
        // Obtener datos del formulario
        const metodoPagoSeleccionado = inputPago.value;
        const notaElem = document.getElementById('nota-general');
        const urgenteElem = document.getElementById('checkUrgente');
        const cedulaElem = document.getElementById('cliente-cedula'); // <--- NUEVO CAMPO

        // Feedback visual en el bot√≥n
        const btn = document.querySelector('button[onclick="enviarPedidoBackend()"]');
        if(btn) {
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Enviando...';
            btn.disabled = true;
        }

        fetch('/api/crear_pedido/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mesa_id: mesaActualId,
                items: carrito,
                notas: notaElem ? notaElem.value : "",
                urgente: urgenteElem ? urgenteElem.checked : false,
                metodo_pago: metodoPagoSeleccionado,
                cliente_cedula: cedulaElem ? cedulaElem.value.trim() : "" // <--- ENVIAMOS LA C√âDULA
            })
        })
        .then(res => {
            if (!res.ok) throw new Error("Error del servidor: " + res.status);
            return res.json();
        })
        .then(data => {
            if(data.status === 'ok') {
                let idOrden = data.id_pedido || "Nuevo";
                alert(`‚úÖ ¬°Orden #${idOrden} Confirmada!\nCliente registrado.`);
                
                // Limpiar campo c√©dula tambi√©n al volver
                if(cedulaElem) cedulaElem.value = ""; 
                volverAMesas();
            } else { 
                alert("‚ùå Error: " + (data.message || data.msg || "Desconocido")); 
            }
        })
        .catch(err => {
            console.error(err);
            alert("‚ùå Error de conexi√≥n.");
        })
        .finally(() => {
            if(btn) {
                btn.innerHTML = '<i class="bi bi-send-check-fill me-2"></i> CONFIRMAR PEDIDO';
                btn.disabled = false;
            }
        });
    }


    // --- FUNCI√ìN 6: MOSTRAR/OCULTAR TICKET (M√≥vil) ---
    function toggleTicket() {
        const menu = document.getElementById('columna-menu');
        const ticket = document.getElementById('columna-ticket');
        
        if (ticket.classList.contains('d-none')) {
            ticket.classList.remove('d-none');
            menu.classList.remove('col-lg-12');
            menu.classList.add('col-lg-7');
        } else {
            ticket.classList.add('d-none');
            menu.classList.remove('col-lg-7');
            menu.classList.add('col-lg-12');
        }
    }
</script>
{% endblock %}